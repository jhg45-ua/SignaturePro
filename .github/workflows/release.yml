name: Release Build

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build and Release
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup dependencies
        run: |
          brew update
          brew install spdlog wxwidgets

      - name: Build application
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          cmake --build build --parallel --config Release

      - name: Verify and prepare app
        run: |
          echo "Checking build output:"
          ls -la build/bin/
          if [ ! -d "build/bin/SignaturePro.app" ]; then
            echo "Error: SignaturePro.app not found!"
            exit 1
          fi
          echo "App bundle contents:"
          ls -la build/bin/SignaturePro.app/
          codesign --force --deep --sign - build/bin/SignaturePro.app
          xattr -cr build/bin/SignaturePro.app
          codesign --verify --verbose build/bin/SignaturePro.app

      - name: Create release package
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Creating package for version: $VERSION"
          cd build/bin
          zip -r ../../SignaturePro-${VERSION}.zip SignaturePro.app
          cd ../..
          ls -la SignaturePro-${VERSION}.zip
          cat > install-signaturepro.sh << 'EOF'
          #!/bin/bash
          echo "SignaturePro Installer"
          echo "====================="
          ZIP_FILE=$(ls SignaturePro-*.zip 2>/dev/null | head -1)
          if [ -z "$ZIP_FILE" ]; then
            echo "Error: No SignaturePro ZIP file found in current directory"
            echo "Please download the SignaturePro-*.zip file first"
            exit 1
          fi
          echo "Found: $ZIP_FILE"
          if [ -d "/Applications/SignaturePro.app" ]; then
              echo "Removing existing installation..."
              sudo rm -rf "/Applications/SignaturePro.app"
          fi
          echo "Installing SignaturePro..."
          unzip -q "$ZIP_FILE"
          sudo mv SignaturePro.app /Applications/
          sudo xattr -r -d com.apple.quarantine "/Applications/SignaturePro.app" 2>/dev/null || true
          echo "Installation complete!"
          echo "You can now run SignaturePro from Applications folder."
          EOF
          chmod +x install-signaturepro.sh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            SignaturePro-*.zip
            install-signaturepro.sh
          name: SignaturePro ${{ github.ref_name }}
          body: |
            ## SignaturePro ${{ github.ref_name }}
            ### Installation Options:
            **Option 1 - Automatic (Recommended):**
            1. Download both files: `SignaturePro-${{ github.ref_name }}.zip` and `install-signaturepro.sh`
            2. Put them in the same folder
            3. Run: `chmod +x install-signaturepro.sh && ./install-signaturepro.sh`
            **Option 2 - Manual:**
            1. Download `SignaturePro-${{ github.ref_name }}.zip`
            2. Extract and drag SignaturePro.app to Applications folder
            3. Run: `sudo xattr -r -d com.apple.quarantine "/Applications/SignaturePro.app"`
            4. Right-click app → Open → Open
            ### System Requirements:
            - macOS 10.15 or later
            - No additional dependencies required
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}